# Wechat4u 常见错误排查指南

## 概述

wechat4u 是免费的微信网页版协议实现，但存在一些已知的稳定性问题。本文档整理了常见错误及解决方案。

## 常见错误类型

### 🔴 错误 -1 (最严重)

**错误信息**：
```
AssertionError [ERR_ASSERTION]: -1 == 0
```

**严重程度**：🔴 严重

**含义**：
- 微信网页版协议底层错误
- 通常表示协议通信失败或被拒绝

**可能原因**：
1. 微信网页版协议变更
2. 账号被微信临时限制或拉黑
3. 网络连接不稳定
4. wechat4u puppet版本过旧
5. 频繁登录/退出导致被风控

**解决方案**：

✅ **立即采取的措施**：
```bash
# 1. 停止程序
Ctrl+C

# 2. 等待 5-10 分钟，让微信服务器重置状态

# 3. 删除缓存文件（如果有）
rm -rf .wechaty
rm -f *.memory-card.json

# 4. 重新启动
npm start
```

✅ **长期解决方案**：
1. **更换账号**：使用注册时间 > 6个月的老账号
2. **升级puppet**：使用付费稳定的puppet
3. **降低使用频率**：不要频繁登录/退出
4. **使用备用方案**：考虑企业微信、钉钉等

---

### ⚠️ 错误 1205 (中等)

**错误信息**：
```
AssertionError [ERR_ASSERTION]: 1205 == 0
```

**严重程度**：⚠️ 警告

**含义**：
- 获取联系人列表失败
- 通常不影响消息收发

**可能原因**：
1. 联系人数据获取超时
2. 微信API临时异常
3. 网络波动

**解决方案**：

✅ **可以忽略**：
- 这个错误通常不影响核心功能
- 消息收发、群聊监控仍然可以正常工作

✅ **如果频繁出现**：
```bash
# 重启程序
Ctrl+C
npm start
```

---

### ❌ 错误 1102 (严重)

**错误信息**：
```
AssertionError [ERR_ASSERTION]: 1102 == 0
```

**严重程度**：❌ 严重

**含义**：
- 账号被微信限制登录网页版

**可能原因**：
1. 新注册的微信账号（未满6个月）
2. 长时间未使用网页版微信
3. 账号被微信风控系统标记

**解决方案**：

✅ **激活网页版权限**：
1. 打开浏览器访问 https://wx.qq.com
2. 使用手机微信扫码登录网页版
3. 正常使用一段时间（发送消息、查看群聊）
4. 退出后等待24小时
5. 再尝试使用机器人

✅ **更换账号**：
- 使用注册时间 > 6个月的账号
- 确保账号已经激活过网页版

---

## 根本原因分析

### wechat4u puppet 的局限性

wechat4u 是基于微信网页版协议的**免费**实现，存在以下问题：

❌ **不稳定因素**：
1. 微信随时可能修改网页版协议
2. 微信对网页版有严格的风控策略
3. 新账号、异常登录会被限制
4. 频繁使用可能被封禁

❌ **已知限制**：
1. 不支持新注册的账号（<6个月）
2. 部分账号无法使用网页版（被微信限制）
3. 容易触发风控（频繁登录、大量消息）
4. 协议随时可能失效

---

## 推荐的替代方案

### 1. 付费 Puppet（推荐）

#### wechaty-puppet-padlocal
- 💰 价格：约 ¥200/月
- ✅ 稳定性高，基于iPad协议
- ✅ 不受微信网页版限制
- ✅ 支持所有账号类型
- 📦 安装：`npm install wechaty-puppet-padlocal`

```javascript
// .env
WECHATY_PUPPET=wechaty-puppet-padlocal
WECHATY_PUPPET_PADLOCAL_TOKEN=你的token
```

#### wechaty-puppet-wechat
- 💰 价格：约 ¥150/月
- ✅ 基于Windows微信协议
- ✅ 稳定性较好
- 📦 安装：`npm install wechaty-puppet-wechat`

### 2. 企业微信（免费）

- ✅ 完全免费
- ✅ 官方支持，稳定可靠
- ✅ 适合企业使用
- 📚 文档：https://work.weixin.qq.com/api/doc

### 3. 钉钉（免费）

- ✅ 完全免费
- ✅ 阿里官方支持
- ✅ 机器人功能丰富
- 📚 文档：https://open.dingtalk.com/

---

## 最佳实践

### 使用 wechat4u 的注意事项

如果坚持使用免费的 wechat4u，请遵循以下最佳实践：

✅ **账号选择**：
- 使用注册时间 > 6个月的老账号
- 确保账号已激活网页版权限
- 不要使用重要账号（避免被封）

✅ **使用习惯**：
- 不要频繁重启程序（每天不超过3次）
- 避免大量发送消息（可能触发风控）
- 保持稳定的网络环境
- 定期清理缓存文件

✅ **错误处理**：
- 遇到 `-1` 错误立即停止，等待10分钟
- 遇到 `1102` 错误，先激活网页版权限
- 遇到 `1205` 错误，可以忽略继续使用

✅ **监控和备份**：
- 使用日志记录所有错误
- 准备备用账号
- 考虑双机热备（主备切换）

---

## 故障排查流程

遇到错误时，按以下流程排查：

```
1. 查看错误代码（-1, 1102, 1205等）
   ↓
2. 根据错误代码查看本文档对应章节
   ↓
3. 尝试简单解决方案（重启、等待）
   ↓
4. 如果问题持续，检查账号状态
   ↓
5. 如果频繁出现，考虑更换puppet
   ↓
6. 生产环境强烈建议使用付费puppet
```

---

## 检查清单

使用此清单诊断问题：

### 账号检查
- [ ] 账号注册时间 > 6个月
- [ ] 可以正常登录网页版微信（https://wx.qq.com）
- [ ] 账号未被限制或封禁
- [ ] 不是新注册的账号

### 网络检查
- [ ] 网络连接稳定
- [ ] 可以访问微信服务器
- [ ] 没有频繁切换IP
- [ ] 没有使用不稳定的代理

### 程序检查
- [ ] wechaty 版本是最新的
- [ ] 依赖包都正确安装
- [ ] 没有频繁重启程序
- [ ] 日志文件正常记录

### 使用检查
- [ ] 没有发送大量消息
- [ ] 没有在多台设备同时登录
- [ ] 没有频繁登录/退出
- [ ] 遵循微信使用规范

---

## 升级到付费 Puppet 指南

如果决定升级到付费puppet，按以下步骤操作：

### 步骤 1：安装 puppet

```bash
# 安装 padlocal puppet
npm install wechaty-puppet-padlocal
```

### 步骤 2：获取 Token

访问 http://pad-local.com/ 购买token

### 步骤 3：修改配置

编辑 `.env` 文件：
```env
# 使用 padlocal puppet
WECHATY_PUPPET=wechaty-puppet-padlocal
WECHATY_PUPPET_PADLOCAL_TOKEN=puppet_padlocal_你的token
```

### 步骤 4：修改代码（如果需要）

`src/index.js`：
```javascript
const bot = WechatyBuilder.build({
  name: config.bot.name,
  puppet: 'wechaty-puppet-padlocal',
  puppetOptions: {
    token: process.env.WECHATY_PUPPET_PADLOCAL_TOKEN,
  },
});
```

### 步骤 5：重启程序

```bash
npm start
```

---

## 总结

| 错误代码 | 严重性 | 可以忽略 | 需要重启 | 需要换账号 | 建议升级puppet |
|---------|--------|---------|---------|-----------|---------------|
| -1      | 🔴 严重 | ❌      | ✅      | ✅        | ✅ 强烈建议    |
| 1102    | ❌ 严重 | ❌      | ✅      | ✅        | ✅ 建议        |
| 1205    | ⚠️ 警告 | ✅      | 可选    | ❌        | 如频繁出现     |

**核心建议**：
- 💡 测试环境：可以使用免费的 wechat4u
- 🚀 生产环境：**强烈建议使用付费 puppet**
- 🔒 重要业务：不要依赖免费方案

---

## 相关资源

- [Wechaty 官方文档](https://wechaty.js.org/)
- [Puppet 对比](https://wechaty.js.org/docs/puppet-providers/)
- [PadLocal 官网](http://pad-local.com/)
- [Wechaty Issues](https://github.com/wechaty/wechaty/issues)

---

**最后更新**：2025-10-14
